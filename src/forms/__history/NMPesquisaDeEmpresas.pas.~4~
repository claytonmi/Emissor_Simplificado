unit NMPesquisaDeEmpresas;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes,
  Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls,
  Data.DB, FireDAC.Comp.Client, uDataModulePrincipal; // Inclui o DataModule

type
  TNMPesquisaDeEmpresa = class(TForm)
    ComboBoxPesquisaDeEmpresa: TComboBox;
    lbPesquisa: TLabel;
    BtSelecionar: TButton;
    BtCancelar: TButton;
    procedure FormShow(Sender: TObject);
    procedure BtSelecionarClick(Sender: TObject);
    procedure BtCancelarClick(Sender: TObject);
  private
    { Private declarations }
  public
    IDEmpresaSelecionada: Integer; // ID da empresa selecionada
  end;

var
  NMPesquisaDeEmpresa: TNMPesquisaDeEmpresa;

implementation

{$R *.dfm}

procedure TNMPesquisaDeEmpresa.FormShow(Sender: TObject);
begin
  // Carregar empresas no ComboBox ao abrir o formulário
  ComboBoxPesquisaDeEmpresa.Clear;

  DataModulePrincipal.FDQueryEmpresa.Close;
  DataModulePrincipal.FDQueryEmpresa.SQL.Text := 'SELECT IDEmpresa, NomeEmpresa FROM Empresa ORDER BY NomeEmpresa';
  DataModulePrincipal.FDQueryEmpresa.Open;

  while not DataModulePrincipal.FDQueryEmpresa.Eof do
  begin
    ComboBoxPesquisaDeEmpresa.Items.AddObject(
      DataModulePrincipal.FDQueryEmpresa.FieldByName('NomeEmpresa').AsString,
      TObject(DataModulePrincipal.FDQueryEmpresa.FieldByName('IDEmpresa').AsInteger)
    );
    DataModulePrincipal.FDQueryEmpresa.Next;
  end;

  DataModulePrincipal.FDQueryEmpresa.Close;
end;

procedure TNMPesquisaDeEmpresa.BtSelecionarClick(Sender: TObject);
begin
  if ComboBoxPesquisaDeEmpresa.ItemIndex <> -1 then
  begin
    // Obtém o ID da empresa selecionada
    IDEmpresaSelecionada := Integer(ComboBoxPesquisaDeEmpresa.Items.Objects[ComboBoxPesquisaDeEmpresa.ItemIndex]);
    ModalResult := mrOk; // Fecha o formulário e retorna sucesso
  end
  else
  begin
    ShowMessage('Selecione uma empresa antes de continuar.');
  end;
end;

procedure TNMPesquisaDeEmpresa.BtCancelarClick(Sender: TObject);
begin
  ModalResult := mrCancel; // Fecha o formulário sem selecionar nada
end;

end.

